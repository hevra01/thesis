#!/bin/bash
#SBATCH -J reconstruct_tokens
#SBATCH -o /ptmp/hevrapetek/thesis/logs/current.out
#SBATCH -e /ptmp/hevrapetek/thesis/logs/current.err
#SBATCH --time=1-00:00:00
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gres=gpu:1
#SBATCH --ntasks-per-core=1
#SBATCH --cpus-per-task=16
#SBATCH --mem=16G

# --- Environment setup ---
module purge
module load anaconda/3/2023.03
source ~/.bashrc
source activate /u/hevrapetek/conda-envs/thesis
source /ptmp/hevrapetek/thesis/.wandb_secrets.sh

# --- Configurable variables ---
EXPERIMENT_NAME=${EXPERIMENT_NAME:-reconstruct_with_tokens}
BASE_START_CLASS=${BASE_START_CLASS:-0}
CLASSES_PER_JOB=${CLASSES_PER_JOB:-30}

TASK_ID=${SLURM_ARRAY_TASK_ID:-0}
START_CLASS=$(( BASE_START_CLASS + TASK_ID * CLASSES_PER_JOB ))
END_CLASS=$(( START_CLASS + CLASSES_PER_JOB ))

# Build the class folder slice (WNIDs) for this task from a static array
# You can generate this list once and paste here (sorted WNIDs under ImageNet train root)
WNIDS=(
  n01665541 n01768244 n01877812 n01986214 n01990800 n02002556 n02007224 n02006656 n02007558 n02009229 n02009912 n02114696 n02108947 n02113706 n02127163 n02128027 n02128757 n02129530 n02129604 n02131653 n02132136 n02133161 n02134084 n02134418 n02137549 n02138441 n02174001 n02231487 n02233338 n02236044 n02268443 n02279972 n02280649 n02281787 n02317335 n02321529 n02325366 n02326432 n02346627 n02356798 n02361337 n02363005 n02389026 n02395406 n02396427 n02403003 n02408429 n02410509 n02412080 n02415577 n02417914 n02422106 n02423022 n02437616 n02441942 n02445715 n02447366 n02454379 n02457408 n02480495 n02481823 n02483362 n02483708 n02484975 n02486261 n02486410 n02487347 n02488291 n02488702 n02489166 n02490219 n02492035 n02492660 n02493509 n02493793 n02494079 n02497673 n02500267 n02504013 n02504458 n02509815 n02510455 n02514041 n02536864 n02606052 n02607072 n02640242 n02641379 n02655020 n02666196 n02667093 n02669723 n02672831 n02676566 n02687172 n02690373 n02692877 n02699494 n02701002 n02704792 n02708093 n02727426 n02727477 n02747177 n02749479 n02769748 n02776631 n02777292 n02782093 n02783161 n02786058 n02788148 n02789797 n02795169 n02797295 n02799071 n02802426 n02804414 n02804610 n02807133 n02808304 n02808440 n02814533 n02814860 n02815834 n02817516 n02823428 n02823750 n02825657 n02834397 n02835271 n02837789 n02840245 n02841315 n02843684 n02859443 n02860847 n02865351 n02869837 n02870880 n02871525 n02877765 n02879718 n02883205 n02892201 n02892767 n02894605 n02895154 n02906734 n02909870 n02910353 n02916936 n02917067 n02927161 n02930766 n02939185 n02948072 n02950826 n02951358 n02951585 n02963159 n02965783 n02966193 n02966687 n02971356 n02974003 n02977058 n02978881 n02979186 n02980441 n02981792 n02988304 n02992211 n02999410 n03000134 n03000684 n03014705 n03016953 n03017168 n03018349 n03026506 n03028079 n03032252 n03041632 n03042490 n03045698 n03047690 n03062245 n03063599 n03063689 n03065424 n03085013 n03089624 n03095699 n03100240 n03109150 n03110669 n03124043 n03124170 n03125729 n03126707 n03127925 n03131574 n03133878 n03134739 n03141823 n03146219 n03160309 n03179701 n03180011 n03187595 n03188531 n03196217 n03197337 n03201208 n03207743 n03207941 n03208938 n03216828 n03218198 n03220513 n03223299 n03240683 n03249569 n03250847 n03255030 n03259280 n03271574 n03272010 n03272562 n03290653 n03291819 n03297495 n03314780 n03325584 n03337140 n03344393 n03345487 n03347037 n03355925 n03372029 n03376595 n03384352 n03388043 n03388183 n03388549 n03393912 n03394916 n03400231 n03404251 n03417042 n03424325 n03425413 n03443371 n03444034 n03445924 n03447447 n03447721 n03450230 n03452741 n03457902 n03459775 n03461385 n03467068 n03476684 n03476991 n03478589 n03481172 n03482405 n03483316 n03485407 n03485794 n03494278 n03495258 n03496892 n03498962 n03530642 n03532672 n03534580 n03535780 n03538406 n03544143 n03584254 n03584829 n03590841 n03594734 n03594945 n03595614 n03598930 n03599486 n03602883 n03617480 n03623198 n03627232 n03630383 n03633091 n03637318 n03642806 n03649909 n03657121 n03658185 n03661043 n03662601 n03666591 n03670208 n03673027 n03676483 n03691459 n03692522 n03697007 n03706229 n03709823 n03710193 n03710637 n03710721 n03717622 n03720891 n03721384 n03724870 n03729826 n03733131 n03733281 n03733805 n03736970 n03742115 n03743016 n03759954 n03761084 n03764736 n03769881 n03770439 n03770679 n03773504 n03775071 n03775546 n03776460 n03777568 n03777754 n03781244 n03782006 n03785016 n03786901 n03787032 n03788195 n03788365 n03791053 n03792782 n03792972 n03793489 n03794056 n03796401 n03803284 n03804744 n03814639 n03814906 n03825788 n03832673 n03837869 n03838899 n03840681 n03841143 n03843555 n03854065 n03857828 n03866082 n03868242 n03868863 n03871628 n03873416 n03874293 n03874599 n03876231 n03877472 n03877845 n03884397 n03977966 n04146614 n04209239 n04254704

)

SEL_WNIDS=( "${WNIDS[@]:$START_CLASS:$CLASSES_PER_JOB}" )
CLASS_FOLDERS_CSV=$(IFS=, ; echo "${SEL_WNIDS[*]}")

echo "[$(date)] Running task $TASK_ID: classes [${SEL_WNIDS[*]}] for experiment=$EXPERIMENT_NAME"
echo "SLURM_JOB_ID=$SLURM_JOB_ID on node $HOSTNAME"

# --- Arguments for Python script ---
ARGS=(
  experiment=$EXPERIMENT_NAME
  experiment.class_folders=[$CLASS_FOLDERS_CSV]
  experiment.output_path=/ptmp/hevrapetek/reconstruction_imagenet/train
  experiment.register_tokens_path=/ptmp/hevrapetek/thesis/data/datasets/imagnet_register_tokens/imagnet_train_register_tokens.npz
  experiment.data_root=/ptmp/hevrapetek/ILSVR2012/train
)

# --- Run ---
cd /ptmp/hevrapetek/thesis
python -u reconstruct_with_tokens_new_version.py "${ARGS[@]}"
